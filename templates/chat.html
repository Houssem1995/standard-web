{% extends "base.html" %}

{% block title %}Live Server Chat - Standard Survival Minecraft Server{% endblock %}

{% block select_chat %}selected{% endblock %}
{% block content %}
    <div id="main">
      <h2>Live Server Chat</h2>
      <div id="chat-container">
        <div id="chat"></div>
        <input id="chat-textbox" type="text">
      </div>
      {% if not user.is_authenticated %}
      <br>
      <div>
        You must be logged in to the website to be able to chat!
      </div>
      {% endif %}
      
      <script src="http://{{ rts_address }}/socket.io/socket.io.js"></script>
      <script type="text/javascript">
          var commandHistory = [];
          var commandIndex = -1;
          var socket;
          
          function addChatLine(line) {
              var $chat = $('#chat');
              var shouldScroll = $chat.get(0).scrollHeight - $chat.scrollTop() == $chat.outerHeight();
              
              $chat.append('<li>' + line + '</li>');
              
              // Scroll to see the new line of text if the bottom was already visible
              if (shouldScroll) {
                  $chat.scrollTop($chat.get(0).scrollHeight);
              }
          }
          
          function socketConnect() {
              if (typeof io === 'undefined') {
                  addChatLine("ERROR: Could not establish socket connection");
                  return;
              }
              
              socket = io.connect('http://{{ rts_address }}/chat');
              
              // Authenticate using the current django session key. It must belong
              // to a superuser to proceed with socket.io connection
              socket.on('connect', function() {
                $("#chat").empty();
                
                var djangoSessionKey = "{{ request.session.session_key }}";
                socket.emit('auth', {
                    djangoSessionKey: djangoSessionKey,
                    serverId: 2
                });
              });
              
              socket.on('disconnect', function() {
                  addChatLine("ERROR: socket disconnected");
              });
              
              socket.on('mc-connection-lost', function() {
                  addChatLine("Connection to Minecraft server lost, retrying...");
              });
              
              // Receive a chat line
              socket.on('chat', function(data) {
                  addChatLine(data.line);
              });
          }
          
          $(document).ready(function() {
              socketConnect();
              
              $("#chat-textbox").keyup(function (e) {
                  switch (e.which) {
                      case 13: //Enter
                          var data = {};
                          var input = $('#chat-textbox').val();
                          
                          socket.emit('chat-input', {
                            message: input
                          });
                          
                          $('#chat-textbox').val("");
                          $('#chat').scrollTop($('#chat').get(0).scrollHeight);
                          
                          commandHistory.unshift(input);
                          commandIndex = -1;
                          break;
                      case 38: //Up
                          if (commandIndex < commandHistory.length - 1) {
                              commandIndex++;
                              $('#chat-textbox').val(commandHistory[commandIndex]);
                          }
                          break;
                      case 40: //Down
                          if (commandIndex > -1) {
                              commandIndex--
                              $('#chat-textbox').val(commandHistory[commandIndex]);
                          }
                          break;
                  }
              });
          })
      </script>
    </div>
{% endblock %}
