{% extends "base.html" %}

{% block title %}Admin - Standard Survival Minecraft Server{% endblock %}

{% block select_admin %}selected{% endblock %}
{% block content %}
    <div class="nav-header">
      <div class="inner">
        <ul>
          {% for server in servers %}
          <li {% if server.id == server_id %}class="selected"{% endif %}>
            <a class="tooltip" href="/{{server.id}}/server-admin" title="Address: {{ server.address }}">{{ server.name }}</a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="sub-header">
      <ul>
        <li>
          <div>Players<span class="stat player-count">-</span></div>
        </li>
        <li>
          <div>TPS<span class="stat tps">-</span></div>
        </li>
        <li>
          <div>Load<span class="stat load">-</span></div>
        </li>
      </ul>
    </div>
    <div class="admin-panel">
      <div class="admin-right">
        <div class="players"></div>
        <div class="users"></div>
      </div>
      <div class="detail">
        
      </div>
      <div class="admin-left">
        <div class="console"></div>
        <input class="console-textbox" type="text">
      </div>
    </div>
    
    <script src="http://{{ rts_address }}/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var commandHistory = [];
        var commandIndex = -1;
        var socket;
        
        var $console;
        
        function addConsoleLine(line) {
            var shouldScroll = $console.get(0).scrollHeight - $console.scrollTop() == $console.outerHeight();
            
            $console.append('<li>' + line + '</li>');
            
            // Scroll to see the new line of text if the bottom was already visible
            if (shouldScroll) {
                $console.scrollTop($console.get(0).scrollHeight);
            }
        }
        
        function socketConnect() {
            if (typeof io === 'undefined') {
                addConsoleLine("ERROR: Could not establish socket connection");
                return;
            }
              
            addConsoleLine("Connecting...");
            
            socket = io.connect('http://{{ rts_address }}/console');
            
            // Authenticate using the current django session key. It must belong
            // to a superuser to proceed with socket.io connection
            socket.on('connect', function() {
                $console.empty();
                
                var djangoSessionKey = "{{ request.session.session_key }}";
                socket.emit('auth', {
                    djangoSessionKey: djangoSessionKey,
                    serverId: {{ server_id }}
                });
            });
            
            socket.on('disconnect', function() {
                addConsoleLine("ERROR: socket disconnected");
            });
            
            // This event is received when the session key is either invalid or doesn't
            // belong to a superuser
            socket.on('unauthorized', function(data) {
                addConsoleLine("ERROR: you are not authorized to access the admin panel!");
            });
            
            socket.on('mc-connection-lost', function() {
                addConsoleLine("Connection to Minecraft server lost, retrying...");
            });
            
            socket.on('mc-connection-restored', function() {
                addConsoleLine("Connection restored!");
            });
            
            // Receive a console output line
            socket.on('console', function(data) {
                if (data.line) {
                    addConsoleLine(data.line);
                } else if (data.batch) {
                    console.log(data.batch);
                    
                    data.batch.map(function(line) {
                        addConsoleLine(line);
                    });
                }
            });
            
            // Update server status display
            socket.on('server-status', function(data) {
                var players = data.players;
                var numPlayers = data.numPlayers;
                var maxPlayers = data.maxPlayers;
                var load = data.load;
                var tps = data.tps;
                
                players = players.sort(function(a, b) {
                    a = (a.nickname ? a.nickname : a.username);
                    b = (b.nickname ? b.nickname : b.username);
                    
                    if (a.toLowerCase() < b.toLowerCase()) return -1;
                    if (a.toLowerCase() > b.toLowerCase()) return 1;
                    return 0;
                });
                
                var playersHtml = '';
                for (var i = 0; i < players.length; ++i) {
                    var username = players[i].username;
                    var nickname = players[i].nickname;
                    
                    var html = ['<div class="player">',
                                    '<a href="/player/' + username + '">',
                                        '<span><img class="face-thumb" src="/faces/16/' + username + '.png">' + (nickname ? nickname : username) + '</span>',
                                    '</a>',
                                '</div>'].join('');
                    
                    playersHtml += html;
                }
                
                $('.players').html(playersHtml);
                $('.player-count').text(numPlayers + '/' + maxPlayers);
                $('.load').text(load);
                $('.tps').text(tps);
            });
            
            socket.on('chat-users', function(data) {
                var users = data.users;
                
                var html = '<b>Chat user count: ' + users.length + '</b>';
                for (var i = 0; i < users.length; ++i) {
                    var username = users[i].username;
                    var address = users[i].address;
                    var type = users[i].type;
                    
                    if (username == 'Server') {
                        html += ['<div class="user">',
                                    username + ' [' + type + ']',
                                '</div>'].join('');
                    } else if (username) {
                        html += ['<div class="user">',
                                    '<a href="/player/' + username + '">',
                                        '<span><img class="face-thumb" src="/faces/16/' + username + '.png">' + username + '</span>',
                                    '</a>',
                                '</div>'].join('');
                    } else {
                        html += ['<div class="user">',
                                    'Anonymous - ' + address,
                                '</div>'].join('');
                    }
                }
                
                $('.users').html(html);
            });
        }
            
        function resize() {
            $console.height($(window).height() - $("#header").outerHeight() - $(".nav-header").outerHeight() - $(".sub-header").outerHeight() - 30);
            $(".players").height($(window).height() - $("#header").outerHeight() - $(".nav-header").outerHeight() - $(".sub-header").outerHeight() - 150);
            $(".users").height(128);
        }
        
        $(document).ready(function() {
            $console = $('.console');
            var $consoleTextbox = $('.console-textbox');
        
            resize();
            
            socketConnect();
            
            $(document).keypress(function (e) {
                if (!$consoleTextbox.is(":focus")
                    && !$('#searchBox').is(':focus')) {
                    $consoleTextbox.focus();
                }
            });
            
            $consoleTextbox.keyup(function (e) {
                switch (e.which) {
                    case 13: //Enter
                        var data = {};
                        var input = $consoleTextbox.val();
                        
                        if (input[0] == "/") {
                            data = {
                                command: input.substring(1, input.length)
                            }
                        } else {
                            data = {
                                message: input
                            }
                        }
                        
                        socket.emit('console-input', data);
                        $consoleTextbox.val("");
                        $console.scrollTop($console.get(0).scrollHeight);
                        
                        commandHistory.unshift(input);
                        commandIndex = -1;
                        break;
                    case 38: //Up
                        if (commandIndex < commandHistory.length - 1) {
                            commandIndex++;
                            $consoleTextbox.val(commandHistory[commandIndex]);
                        }
                        break;
                    case 40: //Down
                        if (commandIndex > -1) {
                            commandIndex--
                            $consoleTextbox.val(commandHistory[commandIndex]);
                        }
                        break;
                }
            });
            
            $(window).resize(function() {
                resize();
                $console.scrollTop($console.get(0).scrollHeight);
            });
        })
    </script>
{% endblock %}
